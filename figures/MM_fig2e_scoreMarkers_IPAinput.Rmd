---
title: "Score markers --  myeloid cells -- clst.MonoM0Only_k200"
subtitle: "mouse"
author: "pz"
date: "11/10/2022; updated `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        toc_float: true
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE)
```

```{r eval=TRUE, include=FALSE, cache=FALSE }
library(SingleCellExperiment);library(magrittr);
library(data.table)
library(patchwork);library(ggplot2)
theme_set(theme_bw(base_size = 16))
```



```{r}
data_dir <- "/Users/pz/Desktop/work/czi-inflammation/pz/combined/"
scm <- readRDS(paste0(data_dir, "sce_MM_M0Mono-only_Reintegrated_2022-06-24_noCounts.rds"))
rownames(scm) <- scater::uniquifyFeatureNames(ID = rowData(scm)$ID, names = rowData(scm)$Symbol)

## defining colors
sample_cols <- colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "Accent")))(length(unique(scm$Sample)))
names(sample_cols) <- sort(unique(scm$Sample))

surgery_cols <- c('MI'="orange", 'sham' = "deepskyblue")

day_cols <- c("d01"="antiquewhite2","d07"="aquamarine3","d30"="darkgoldenrod")

tissue_cols <- c("heart"="brown4","blood" = "coral2", "liver"="slategray3","islets"="deeppink1","kidney"="chartreuse2")

cluster_cols = ABCutilities:::fx.get_palette_ABC("tableau20")[1:length(unique(scm$clst.MonoM0Only_k200))]
names(cluster_cols) <- sort(unique(scm$clst.MonoM0Only_k200))
cdata = colData(scm)
#saveRDS(cdata, "mouse_myeloid_cdata.Rds")
```


```{r fig.height = 7.5, fig.width = 15}
p1 <- scABC2::plot_reducedDim_from_sce(scm, which_reddim = "UMAP",
    color_by = "clst.MonoM0Only_k200", set_color=FALSE) +
    theme(legend.position = "right") +
    scale_color_manual(values=cluster_cols)
p2 <- scABC2::plot_reducedDim_from_sce(scm, which_reddim = "UMAP",
    color_by = "tissue", set_color=FALSE) +
    theme(legend.position = "right") +
    scale_color_manual(values=tissue_cols)
p1+p2
```


# ScoreMarkers

In the context of marker detection, the area under the curve (AUC) quantifies our ability to distinguish between two distributions in a pairwise comparison. The AUC represents the probability that a randomly chosen observation from our cluster of interest is greater than a randomly chosen observation from the other cluster. A value of 1 corresponds to upregulation, where all values of our cluster of interest are greater than any value from the other cluster; a value of 0.5 means that there is no net difference in the location of the distributions; and a value of 0 corresponds to downregulation.

The most obvious summary statistic is the mean. For cluster  X, a large mean effect size (>0.5 for the AUCs) indicates that the gene is upregulated in X compared to the average of the other groups:

-mean.*, the mean effect size across all pairwise comparisons involving X. A large value (>0 for log-fold changes, >0.5 for the AUCs) indicates that the gene is upregulated in X compared to the average of the other groups. A small value (<0 for the log-fold changes, <0.5 for the AUCs) indicates that the gene is downregulated in X instead.



```{r}
mrks <- scran::scoreMarkers(scm, group = scm$clst.MonoM0Only_k200, block = scm$Sample)

mrks_l = lapply(as.list(mrks), function(x){
  auc.only <- x[,grepl("mean.AUC|mean.logFC.cohen", colnames(x))]
  x = data.frame(gene=row.names(auc.only), auc.only)
  x
})

mrks_l_filt = lapply(as.list(mrks), function(x){
  auc.only <- x[,grepl("mean.AUC|mean.logFC.cohen", colnames(x))]
  x = data.frame(gene=row.names(auc.only), auc.only)
  x= subset(x, mean.AUC > 0.6)
  x
})
data_dir = "2021_21_mouse_scoreMarkers_myeloid/"

openxlsx::write.xlsx(mrks_l_filt, file = paste0(data_dir,"MM_scoreMarkers_clst.MonoM0Only_k200_2022-11_auc_filtered_meanAUCgt0.6.xlsx"))
```


```{r}
df_sig = lapply(1:length(mrks), function(x){
  sub = mrks[[x]]
  data.frame(cluster=paste0("cls",x), 
             "mean.AUC>0.6" = nrow(subset(sub, mean.AUC > 0.6)),
             "mean.AUC>0.7" = nrow(subset(sub, mean.AUC > 0.7)), check.names=F)
}) %>% rbindlist()
df_df = reshape2::melt(df_sig)
cluster_cols_s = cluster_cols
names(cluster_cols_s) = paste0("cls", names(cluster_cols_s))
ggplot(df_df, aes(x=cluster, y=value, fill=cluster)) + geom_col() + facet_wrap(~variable, scales="free") + theme_bw() + theme(legend.position = "none") + xlab("") + ylab("Number of Marker Genes") + scale_fill_manual(values=cluster_cols_s) + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```



# Session Info

```{r session, message=FALSE, warning=FALSE, cache=FALSE,echo=FALSE, fig.width=10, fig.height=5.5, context="data"}
sessionInfo()
```
