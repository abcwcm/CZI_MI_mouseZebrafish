---
title: "Dotplot from IPA results"
subtitle:  "FIG_2A"
author: "pz"
date: "1/30/2023; updated `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        toc_float: true
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE)
```

```{r eval=TRUE, include=FALSE, cache=FALSE }
library(ggplot2);library(openxlsx);library(magrittr);library(data.table);library("readxl")
theme_set(theme_bw(base_size = 16))
```




```{r, fig.width=10, fig.height=10}
data_dir <- "./FIG_2A_IPAres/"
files = list.files(path=data_dir, pattern=".xls", full.names = T)
ipa_res =   lapply(files, function(x){
  print(x)
  in.df = read_excel(x, skip=1, col_names=T)
  in.df$cls =  gsub(".*/", "", x) %>% gsub(".xls", "", .)
  in.df
}) %>%  rbindlist()
colnames(ipa_res) = make.names(colnames(ipa_res))
ipa_res = subset(ipa_res, X.log.p.value. > -log10(0.01))
ipa_res = subset(ipa_res, Ratio > 0.025)

# top 10 from each
ipa_pathways_of_interest =   lapply(files, function(x){
  print(x)
  in.df = read_excel(x, skip=1, col_names=T)
  colnames(in.df) = make.names(colnames(in.df))
  in.df = subset(in.df, X.log.p.value. > -log10(0.01) &  Ratio > 0.025)
  in.df = head(in.df, 10)
  in.df$cls =  gsub(".*/", "", x) %>% gsub(".xls", "", .)
  in.df
}) %>%  rbindlist()
colnames(ipa_pathways_of_interest) = make.names(colnames(ipa_pathways_of_interest))

poi = unique(ipa_pathways_of_interest$Ingenuity.Canonical.Pathways)
poi = poi[poi %in% ipa_res$Ingenuity.Canonical.Pathways]

ipa_res_sub = subset(ipa_res, Ingenuity.Canonical.Pathways %in% poi )

ipa_res_sub$cls = factor(ipa_res_sub$cls, levels=c("Blood Monocytes 1dpi", "Blood Monocytes 7dpi", "Blood Monocytes 30dpi"))
```


# Dotplot

```{r, fig.width=8, fig.height=8}
df = dcast(ipa_res_sub[,c("Ingenuity.Canonical.Pathways", "cls", "X.log.p.value.")], Ingenuity.Canonical.Pathways~cls) %>% as.data.frame()
row.names(df) = df$Ingenuity.Canonical.Pathways
df$Ingenuity.Canonical.Pathways = NULL
df[is.na(df)] = 0
p = pheatmap::pheatmap(df, cluster_cols = F, silent=T)
ipa_res_sub$Ingenuity.Canonical.Pathways = factor(ipa_res_sub$Ingenuity.Canonical.Pathways, levels= row.names(df[p$tree_row$order,]))

lvls = c("Eicosanoid Signaling", "Phagosome Maturation","Phagosome Formation","Antigen Presentation Pathway","Integrin Signaling","FcÎ³ Receptor-mediated Phagocytosis in Macrophages and Monocytes","Glioma Invasiveness Signaling","Regulation of Actin-based Motility by Rho","EIF2 Signaling","Actin Nucleation by ARP-WASP Complex","mTOR Signaling","Atherosclerosis Signaling","Role Of Osteoclasts In Rheumatoid Arthritis Signaling Pathway","Macrophage Alternative Activation Signaling Pathway","Pathogen Induced Cytokine Storm Signaling Pathway","Granulocyte Adhesion and Diapedesis","Agranulocyte Adhesion and Diapedesis","Acute Phase Response Signaling","LXR/RXR Activation","IL-10 Signaling","Complement System","Neutrophil Extracellular Trap Signaling Pathway","Multiple Sclerosis Signaling Pathway")

ipa_res_sub$Ingenuity.Canonical.Pathways = factor(ipa_res_sub$Ingenuity.Canonical.Pathways, levels= lvls)

ggplot(ipa_res_sub, aes(x = cls, y = Ingenuity.Canonical.Pathways, size = X.log.p.value.)) + geom_point(aes(fill = z.score), pch = 21)   + scale_fill_gradient2(low = "blue", midpoint = 0, mid = "white", high = "red", name="activation\nz-score") + ylab(NULL) + ggtitle("") + DOSE::theme_dose(12) + scale_size_continuous(range = c(3, 8),name="-log(p-value)") + guides(size = guide_legend(order = 1), color = guide_colorbar(order = 2)) + xlab("") + theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1))             
```




# Session Info

```{r session, message=FALSE, warning=FALSE, cache=FALSE,echo=FALSE, fig.width=10, fig.height=5.5, context="data"}
sessionInfo()
```
