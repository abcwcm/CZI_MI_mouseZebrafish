---
title: "ORT in common"
subtitle: "mouse/zebrafish myeloid clusters"
author: "pz"
date: "11/10/2022; updated `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        toc_float: true
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE)
```

```{r eval=TRUE, include=FALSE, cache=FALSE }
library(SingleCellExperiment);library(magrittr);
library(data.table)
library(patchwork);library(ggplot2);library(kableExtra);library(openxlsx)
library(ggsci)
theme_set(theme_bw(base_size = 16))
```




# ORT common  {.tabset}

Previously, we ran ORT testing for GO BP, CC, and MF on zebrafish and mouse clusters separately.  Let's see if we find any enriched terms (p.adjust < 0.05) shared between zebrafish-mouse that have high alignment scores according to SAMap.

## Mm1 – Dr4 

```{r mm1_dr4_gpBP, eval=TRUE, fig.width=8, fig.height=10, results='asis'}
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls1")
zf_go = subset(zf_go, Cluster == "cls4")

intersection = intersect(mm_go$ID, zf_go$ID)

merged = rbind(mm_go,zf_go)
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=18) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm1 - Dr4", subtitle = "shared GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50))
print(p1)
```


### Reduce GO terms

```{r mm1_dr4_gpBP_reduced, eval=TRUE, fig.width=9, fig.height=4, results='asis'}
library(rrvgo)
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls1")
zf_go = subset(zf_go, Cluster == "cls4")


intersection = intersect(mm_go$ID, zf_go$ID)

simMatrix <- calculateSimMatrix(intersection,
                                orgdb="org.Mm.eg.db",
                                ont="BP",
                                method="Rel")
reducedTerms <- reduceSimMatrix(simMatrix,
                                threshold=0.5,
                                orgdb="org.Mm.eg.db")

heatmapPlot(simMatrix,
            reducedTerms,
            annotateParent=TRUE,
            annotationLabel="parentTerm",
            fontsize=6)


intersection = reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent
merged = rbind(mm_go,zf_go) #merge(zf_go, mm_go, by="ID")
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=18) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm1 - Dr4", subtitle = "shared reduced GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50))
print(p1)
```


{.tabset}

## Mm4 – Dr6
 
```{r mm4_dr6_gpBO, eval=TRUE, fig.width=9, fig.height=13}
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls4")
zf_go = subset(zf_go, Cluster == "cls6")

intersection = intersect(mm_go$ID, zf_go$ID)

merged = rbind(mm_go,zf_go) #merge(zf_go, mm_go, by="ID")
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=17) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm4 - Dr6", subtitle = "shared GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 60))
print(p1)
```

### Reduce GO terms

 
```{r mm4_dr6_gpBO_reduced, eval=TRUE, fig.width=9, fig.height=4, results='asis'}
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls4")
zf_go = subset(zf_go, Cluster == "cls6")

intersection = intersect(mm_go$ID, zf_go$ID)


simMatrix <- calculateSimMatrix(intersection,
                                orgdb="org.Mm.eg.db",
                                ont="BP",
                                method="Rel")
reducedTerms <- reduceSimMatrix(simMatrix,
                                threshold=0.5,
                                orgdb="org.Mm.eg.db")

heatmapPlot(simMatrix,
            reducedTerms,
            annotateParent=TRUE,
            annotationLabel="parentTerm",
            fontsize=6)

intersection = reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent


merged = rbind(mm_go,zf_go) 
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=17) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm4 - Dr6", subtitle = "shared GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 60))
print(p1)
```



{.tabset}

## Mm6 – Dr3
 
```{r mm6_dr3_goBP, eval=TRUE, fig.width=8, fig.height=3, results='asis'}
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls6")
zf_go = subset(zf_go, Cluster == "cls3")

intersection = intersect(mm_go$ID, zf_go$ID)

merged = rbind(mm_go,zf_go) #merge(zf_go, mm_go, by="ID")
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=18) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm6 - Dr3", subtitle = "shared GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50))
print(p1)
```


### Reduce GO terms

```{r mm6_dr3_goBP_reduced, eval=TRUE, fig.width=8, fig.height=3, results='asis'}
mm_go = read.xlsx("MM_ORT_scoreMarkers_clst.MonoM0Only_k200_2022-11_aucGt0.6_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
mm_go$species = "MM"
zf_go = read.xlsx("ZF_ORT_scoreMarkers_M0_k50_cl9.15k50_2022-11_meanAUCgtqvalueCutoff_GOBP_unfiltered.xlsx") %>% subset(., p.adjust < 0.05)
zf_go$species = "ZF"

mm_go = subset(mm_go, Cluster == "cls6")
zf_go = subset(zf_go, Cluster == "cls3")

intersection = intersect(mm_go$ID, zf_go$ID)


intersection = intersect(mm_go$ID, zf_go$ID)


simMatrix <- calculateSimMatrix(intersection,
                                orgdb="org.Mm.eg.db",
                                ont="BP",
                                method="Rel")
reducedTerms <- reduceSimMatrix(simMatrix,
                                threshold=0.5,
                                orgdb="org.Mm.eg.db")

heatmapPlot(simMatrix,
            reducedTerms,
            annotateParent=TRUE,
            annotationLabel="parentTerm",
            fontsize=6)


intersection = reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent

merged = rbind(mm_go,zf_go)
merged = merged[merged$ID %in% intersection,]

cat("\n\n###","GO BP", "\n\n")
sub = merged
sub = sub[order(sub$p.adjust, decreasing = F),]
sub$negLog10 = -log10(sub$p.adjust)
sub$Description = factor(sub$Description, levels=rev(unique(sub$Description)))
sub$species = factor(sub$species, levels=c("ZF", "MM"))
p1 = ggplot(sub, aes(x=Description, y=negLog10, fill=species)) + geom_bar(position="dodge", stat="identity") + coord_flip()  +  theme_bw(base_size=17) + theme(legend.position = "right") + xlab("") + ylab("-log10(q)") + scale_fill_npg(name="species") + geom_hline(yintercept = -log10(0.05), linetype="dashed")  + ggtitle("Mm6 - Dr3", subtitle = "shared GO BP terms") + scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50))
print(p1)
```

# Session Info

```{r session, message=FALSE, warning=FALSE, cache=FALSE,echo=FALSE, fig.width=10, fig.height=5.5, context="data"}
sessionInfo()
```
