---
title: "Find markers in mouse + zebrafish when comparing MI/sham or DPI/ctrl in heart"
subtitle: "compare logFC of homologous genes between clusters"
author: "pz"
date: "`r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        toc_float: true
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE)
```

```{r eval=TRUE, include=FALSE, cache=FALSE }
library(SingleCellExperiment);library(magrittr);
library(data.table); library(ggpubr) ; library(ggpmisc)
library(patchwork);library(ggplot2)
theme_set(theme_bw(base_size = 16))
library(ggsci)
library(ggpubr)
library(openxlsx)
library(ggrepel)
library(rrvgo)

```


```{r}
# read in homology table from FRD
homologs = readRDS("/Users/pz/Desktop/work/czi-inflammation/combined/data/rowData_ZFMMHomolog.RDS")
```

# Heart

## Mouse findMarkers

Input file = `sce_MM_M0Mono-only_Reintegrated_2022-06-24_noCounts.rds`

```{r}
data_dir <- "/Users/pz/Desktop/work/czi-inflammation/pz/combined/"
scm <- readRDS(paste0(data_dir, "sce_MM_M0Mono-only_Reintegrated_2022-06-24_noCounts.rds"))
rownames(scm) <- scater::uniquifyFeatureNames(ID = rowData(scm)$ID, names = rowData(scm)$Symbol)
scm = scm[,scm$tissue == "heart"]
scm = scm[,scm$day != "d30"]

table(scm$tissue)
table(scm$day)
```

For each cluster (clst.MonoM0Only_k200), for each day (d01,d07), compare MI vs. SHAM using the scran::findMarkers(lfc=0.25) function.

```{r find_mouse_deg_heart, eval=TRUE}
SPECIES="mm"
ORGAN = "mouse_myeloidClusters_heart"
sct <- scm
mks_all_mm <- lapply(unique(as.character(sct$clst.MonoM0Only_k200)), function(CLUSTER){
    ss <- sct[, as.character(sct$clst.MonoM0Only_k200) == CLUSTER]
    lapply(sort(unique(as.character(ss$day))), function(DAY){
        ss <- ss[, as.character(ss$day) == DAY]
        if(length(unique(ss$surgery)) > 1 & all(table(ss$surgery) > 0)){ # > 50
                    mks <- scran::findMarkers(ss, group = ss$surgery, lfc=0.25)$MI
                    mks$gene <- rownames(mks)
                    mks$comp <- paste(paste0("cls", CLUSTER), DAY, SPECIES, sep = ".")
                    return(as.data.table(mks))
                } %>% rbindlist }) %>% rbindlist }) %>% rbindlist
comps = gtools::mixedsort(unique(mks_all_mm$comp))
# select homologs only
mrks = lapply(comps, function(x) {
  out = subset(mks_all_mm, comp == x)
  out = merge(out, homologs, by.x="gene", by.y="mm.GeneSymbol")
  out
})
names(mrks) = comps
mm_all = mrks %>% rbindlist
#openxlsx::write.xlsx(mrks, file =paste0("MM_", ORGAN,"findMarkers_unfiltered_homlogs_only.xlsx"))
```

```{r, fig.height=5}
df_sig = lapply(1:length(mrks), function(x){
  sub = mrks[[x]]
  data.frame(cluster=unique(sub$comp), 
              "FDR<0.10" =  nrow(subset(sub, FDR < 0.10)),check.names=F)
}) %>% rbindlist()
df_df = reshape2::melt(df_sig)
ggplot(df_df, aes(x=cluster, y=value, fill=cluster)) + geom_col() + facet_wrap(~variable, scales="free") + theme_bw() + theme(legend.position = "none") + xlab("") + ylab("Number of DEGs")  + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```



## Zebrafish findMarkers

Input file = `sce_ZF_sampleIntegration_2022-02-02_noCounts.rds`

```{r}
data_dir="/Users/pz/Desktop/work/czi-inflammation/pz/combined/"
sce <- readRDS(paste0(data_dir, "sce_ZF_sampleIntegration_2022-02-02_noCounts.rds"))
coldata <- readRDS(paste0(data_dir,"colData_ZF_withM0Only-and-EpiCardMix-Redone.rds"))
reddim <- readRDS(paste0(data_dir,"reducedDimList_ZF_withM0Only-and-EpiCardMix-Redone.rds"))

table(row.names( colData(sce)) == row.names(coldata))
table(row.names(reddim@listData$UMAP) == row.names(reducedDim(sce, "UMAP")))
colData(sce) = coldata
reducedDims(sce) = reddim
scz = sce
scz = scz[,!is.na(scz$M0_k50_cl9.15k50)]
rownames(scz) <- scater::uniquifyFeatureNames(ID = rowData(scz)$ID, names = rowData(scz)$Symbol)

scz = scz[,scz$Tissue == "Heart"]
table(scz$Tissue)
```

For each cluster (M0_k50_cl9.15k50), for each day (dpi1,dpi7), compare day vs control using the scran::findMarkers(lfc=0.25) function.

```{r find_fish_deg_heart, degs}
SPECIES="dr"
ORGAN="zebrafish_myeloidClusters_heart"
scz = scz
scz$repl <- gsub(".+-([12])$", "rep\\1", scz$Sample)
sct <-  scz
rdata = rowData(scz)
mks_all_dr <- lapply(unique(as.character(sct$M0_k50_cl9.15k50)), function(CLUSTER){
  ss <- sct[, as.character(sct$M0_k50_cl9.15k50) == CLUSTER]
  lapply(c("dpi1","dpi7"), function(DAY){
    ss <- ss[, as.character(ss$post.surgery) %in% c(DAY, "ctrl")]
    if(length(unique(ss$post.surgery)) > 1 & all(table(ss$comb_condition) > 0)){ # >50
      mks <- scran::findMarkers(ss, group = ss$post.surgery, block=ss$repl, lfc=0.25)[[DAY]]
      mks$gene <- rownames(mks)
      mks = base::merge(mks, rdata, by.x="gene", by.y="Symbol")
      mks$comp <- paste(paste0("cls", CLUSTER), DAY, SPECIES, sep = ".")
      return(as.data.table(mks))
    } %>% rbindlist }) %>% rbindlist }) %>% rbindlist

comps =  gtools::mixedsort(unique(mks_all_dr$comp))
comps = gtools::mixedsort(comps)
mrks = lapply(comps, function(x) {
  out = subset(mks_all_dr, comp == x)
  out = merge(out, homologs, by.x="ID", by.y="zf.ENSEMBL")
  out
})
names(mrks) = comps
dr_all = mrks %>% rbindlist
#openxlsx::write.xlsx(mrks, file =paste0("ZF_", ORGAN,"findMarkers_unfiltered_homlogs_only.xlsx"))
```

```{r, fig.height = 5}
df_sig = lapply(1:length(mrks), function(x){
  sub = mrks[[x]]
  data.frame(cluster=unique(sub$comp), 
              "FDR<0.10" =  nrow(subset(sub, FDR < 0.10)),check.names=F)
}) %>% rbindlist()
df_df = reshape2::melt(df_sig)
ggplot(df_df, aes(x=cluster, y=value, fill=cluster)) + geom_col() + facet_wrap(~variable, scales="free") + theme_bw() + theme(legend.position = "none") + xlab("") + ylab("Number of DEGs")  + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```



## Compare logFC 

Using FDR<0.10 as cutoff for "sig"..

### mm4 vs dr6

```{r comps}
comps = list("cls4.d01.mm-cls6.dpi1.dr",
             "cls4.d07.mm-cls6.dpi7.dr",
             "cls1.d01.mm-cls4.dpi1.dr",
             "cls1.d07.mm-cls4.dpi7.dr")

```


```{r}
plotScatter <- function (x = NULL, y = NULL, tissue = NULL) {
  # retrieve data
  x.df = subset(mm_all, comp == x)
  y.df = subset(dr_all, comp == y)
  
  # Merge data frames by "comb.ENS" 
  df = merge(x.df, y.df, by="comb.ENS")
  
  # Add new columns to categorize data points
  df$sig = ifelse(df$FDR.x <0.10 & df$FDR.y > 0.10, "mm",
                  ifelse(df$FDR.y < 0.10 & df$FDR.x > 0.10 , "dr",
                         ifelse(df$FDR.x <0.10 & df$FDR.y < 0.10, "both",
                                "neither")))
  df$direction = ifelse(df$summary.logFC.x > 0 & df$summary.logFC.y > 0, "up", 
                        ifelse(df$summary.logFC.x < 0 & df$summary.logFC.y < 0, "down", 
                               ifelse(df$summary.logFC.x <= 0 & df$summary.logFC.y >= 0, "discordant_1", 
                                      ifelse(df$summary.logFC.x >= 0 & df$summary.logFC.y <= 0, "discordant_2", "na"))))
  
  # Set transparency (alpha) for data points depending on significance 
  alpha <- ifelse(df$sig != "neither", 0.7, 0.3)
  
  # Add quadrant
  which_quadrant <- function(x, y) {
    z <- ifelse(x >= 0 & y >= 0,
                1L,
                ifelse(x >= 0 & y < 0,
                       2L,
                       ifelse(x < 0 & y < 0,
                              3L,
                              4L)))
    z
  }
  
  
  df = df %>% dplyr::mutate(quadrant = which_quadrant(df$logFC.sham, df$logFC.ctr))
  
  # Add new column to group data points
  df$group = "na"
  df[df$FDR.x < 0.10 & df$logFC.sham > 0 & df$FDR.y < 0.10 & df$logFC.ctrl > 0,]$group = "UP BOTH" # UP BOTH
  df[df$FDR.x < 0.10 & df$logFC.sham < 0 & df$FDR.y < 0.10 & df$logFC.ctrl < 0,]$group = "DOWN BOTH" # DOWN BOTH
  df[df$FDR.x < 0.10 & df$logFC.sham > 0 & df$FDR.y < 0.10 & df$logFC.ctrl < 0,]$group = "UP MM, DOWN ZF" # UP MM, DOWN ZF
  df[df$FDR.x < 0.10 & df$logFC.sham < 0 & df$FDR.y < 0.10  & df$logFC.ctrl > 0 ,]$group = "DOWN MM, UP ZF" # DOWN MM, UP ZF
  
  # Add new column to group data points
  df$group2 = "na"
  df[df$quadrant == 1 & (df$FDR.x < 0.10  | df$FDR.y < 0.10 ),]$group2 = "SIG.QUAD1.MM.OR.ZF" # 
  df[df$quadrant == 2 & (df$FDR.x < 0.10  | df$FDR.y < 0.10 ),]$group2 = "SIG.QUAD2.MM.OR.ZF" # 
  df[df$quadrant == 3 & (df$FDR.x < 0.10  | df$FDR.y < 0.10 ),]$group2 = "SIG.QUAD3.MM.OR.ZF" # 
  df[df$quadrant == 4 & (df$FDR.x < 0.10  | df$FDR.y < 0.10 ),]$group2 = "SIG.QUAD4.MM.OR.ZF" # 
  
  
  
  data_list <- split(df, f = df$group)                     # Split data
  data_list = data_list[grep("na", names(data_list), invert=T)]
  
  data_list2 <- split(df, f = df$group2)                     # Split data
  data_list2 = data_list2[grep("na", names(data_list2), invert=T)]
  
 # doORT(data_list = data_list, org ="org.Mm.eg.db", name = paste0(tissue,"_",x,"_vs_",y,"_ORT_AND.xlsx"))
  
#  doORT(data_list = data_list2, org ="org.Mm.eg.db", name =  paste0(tissue,"_",x,"_vs_",y,"_ORT_OR.xlsx"))
  
  all = c(list("unfiltered" = df), data_list, data_list2)
  
  
  # plot
  p = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(size=3, alpha=alpha,aes(shape=sig, color=direction))+
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1)
  
  p1 = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(size=3, alpha=alpha,aes(shape=sig, color=direction))+
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1)+
    geom_text_repel(data=df[df$sig == "both" & df$direction %in% c("up", "down"),], aes(x=logFC.sham,y=logFC.ctrl,label=comb.rn.y),max.overlaps =Inf, size=3)
  
  
  p2 = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(size=3, alpha=alpha,aes(color=as.character(quadrant)))+
    scale_color_manual(values=c("1"= "#EE0000FF", "2"= "orange", "3"="#3B4992FF","4"="#008B45FF"), name="quadrant") + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1)
  
  p3 = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(data=subset(df, sig == "both"),size=3,alpha=0.7, aes(shape=sig, color=direction)) +
    geom_point(data=subset(df, sig != "both"),size=3, alpha=0.2,aes(shape=sig), color="gray") +
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1)
  
  p4 = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(data=subset(df, sig != "neither"),size=3, alpha=0.7, aes(shape=sig, color=direction)) +
    geom_point(data=subset(df, sig == "neither"),size=3, alpha=0.2,aes(shape=sig), color="gray") +
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1) 
  
  # and / or depending on quadrant
    ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
    geom_point(data=subset(df, sig == "both" & direction %in% c("up", "down") ),size=3, alpha=0.7, aes(shape=sig, color=direction)) +
    geom_point(data=subset(df, sig != "neither" & direction %in% c("discordant_1", "discordant_2")),size=3, alpha=0.7, aes(shape=sig, color=direction)) +
    geom_point(data=subset(df, sig == "neither"),size=3, alpha=0.2,aes(shape=sig), color="gray") +
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1) 
    
    
    
    
    
    p5 = ggplot(df, aes(x=logFC.sham, y=logFC.ctrl)) +
      geom_point(data=df,size=3, alpha=0.2,aes(shape=sig), color="gray") +
    geom_point(data=subset(df, sig == "both" & quadrant %in% c("1", "3") ),size=3, alpha=0.7, aes(shape=sig, color=direction)) +
    geom_point(data=subset(df, sig != "neither" & quadrant %in% c("2", "4")),size=3, alpha=0.7, aes(shape=sig, color=direction)) +
    scale_shape_manual(values=c("both"=16, "mm"=17,"dr"=15,"neither"=3), name="sig")+
    scale_color_manual(values=c("discordant_1"= "#EE0000FF", "discordant_2"= "orange", "down"="#3B4992FF","up"="#008B45FF")) + 
    theme(legend.position="right")+
    ggtitle(tissue, paste0(x," vs. ",y))+
    xlab("log2FC(MI - Sham)")+
    ylab("log2FC(Injured - Ctrl)")+
    geom_vline(xintercept = 0, linetype="dotted", size=1)+
    geom_hline(yintercept = 0, linetype="dotted", size=1) +
          stat_quadrant_counts(data= subset(df, sig ==  "both" & quadrant %in% c("1", "3")), aes(x=logFC.sham, y=logFC.ctrl, label=after_stat(count)), colour = "black", xintercept = 0, yintercept = 0, quadrants=c(1,3))       + stat_quadrant_counts(data= subset(df, sig !=  "neither" & quadrant %in% c("2", "4")), aes(x=logFC.sham, y=logFC.ctrl, label=after_stat(count)), colour = "black", xintercept = 0, yintercept = 0 , quadrants=c(2,4)) +  ggtitle(tissue, paste0(x," vs. ",y," (AND quad 1,3 ; OR quad 2,4)"))
          
          
    
#  print(p1)
 # print(p)
#  print(p + stat_quadrant_counts(data= subset(df, sig ==  "both"), aes(x=logFC.sham, y=logFC.ctrl, label=after_stat(count)), colour = "black", xintercept = 0, yintercept = 0) + ggtitle(tissue, paste0(x," vs. ",y, " (AND)")))
#  print(p + stat_quadrant_counts(data= subset(df, sig !=  "neither"), aes(x=logFC.sham, y=logFC.ctrl, label=after_stat(count)), colour = "black", xintercept = 0, yintercept = 0) +  ggtitle(tissue, paste0(x," vs. ",y," (OR)")))
#  print(p2)
#  print(p3 + ggtitle(tissue, paste0(x," vs. ",y, " (AND)"))) 
#  print(p4 +  ggtitle(tissue, paste0(x," vs. ",y," (OR)")))
  print(p5)

#  write.xlsx(all,paste0(tissue,"_",x,"_vs_",y,".xlsx"))
}


doORT <- function(data_list = NULL, org ="org.Mm.eg.db", name = NULL) {
  comp.list <- lapply(names(data_list), function(x){
    x = data_list[[x]]
    x = clusterProfiler::bitr(x$mm.GeneSymbol , fromType="SYMBOL", toType="ENTREZID",OrgDb=org) %>%  as.data.table 
    return(x$ENTREZID)
  })
  names(comp.list) <-  names(data_list)
  cp.GO.BP = try(clusterProfiler::compareCluster(comp.list, fun="enrichGO",  OrgDb = org, ont="BP",pvalueCutoff = 0.05, qvalueCutoff=1, readable=TRUE))
  
  if(class(cp.GO.BP) != "try-error"){ 
    cp.GO.BP = cp.GO.BP %>% as.data.frame() %>% subset(., p.adjust < 0.05)
    
    simMatrix <- calculateSimMatrix(cp.GO.BP$ID,
                                    orgdb="org.Mm.eg.db",
                                    ont="BP",
                                    method="Rel")
    reducedTerms <- reduceSimMatrix(simMatrix,
                                    threshold=0.5,
                                    orgdb="org.Mm.eg.db")
    cp.GO.BP_red <- subset(cp.GO.BP, ID %in% reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent)
  } else {
    cp.GO.BP = NULL
    cp.GO.BP_red = NULL
  }
  
  cp.GO.CC = try(clusterProfiler::compareCluster(comp.list, fun="enrichGO",  OrgDb = org, ont="CC",pvalueCutoff = 0.05, qvalueCutoff=1, readable=TRUE))
  
  if(class(cp.GO.CC) != "try-error"){ 
    cp.GO.CC = cp.GO.CC %>% as.data.frame() %>% subset(., p.adjust < 0.05)
    
    simMatrix <- calculateSimMatrix(cp.GO.CC$ID,
                                    orgdb=org,
                                    ont="CC",
                                    method="Rel")
    reducedTerms <- reduceSimMatrix(simMatrix,
                                    threshold=0.5,
                                    orgdb=org)
    cp.GO.CC_red <- subset(cp.GO.CC, ID %in% reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent)
  } else {
    cp.GO.CC = NULL
    cp.GO.CC_red = NULL
  }
  
  cp.GO.MF = try(clusterProfiler::compareCluster(comp.list, fun="enrichGO",  OrgDb = org, ont="MF",pvalueCutoff = 0.05, qvalueCutoff=1, readable=TRUE))
  if(class(cp.GO.MF) != "try-error"){ 
    cp.GO.MF = cp.GO.MF %>% as.data.frame() %>% subset(., p.adjust < 0.05)
    
    simMatrix <- calculateSimMatrix(cp.GO.MF$ID,
                                    orgdb="org.Mm.eg.db",
                                    ont="MF",
                                    method="Rel")
    reducedTerms <- reduceSimMatrix(simMatrix,
                                    threshold=0.5,
                                    orgdb="org.Mm.eg.db")
    cp.GO.MF_red <- subset(cp.GO.MF, ID %in% reducedTerms[which(reducedTerms$go == reducedTerms$parent), ]$parent)
  } else {
    cp.GO.MF = NULL
    cp.GO.MF_red = NULL
  }
  
  gol = list(GO.BP = cp.GO.BP,
             GO.CC = cp.GO.CC,
             GO.MF = cp.GO.MF,
             cp.GO.BP_red = cp.GO.BP_red,
             cp.GO.CC_red = cp.GO.CC_red,
             cp.GO.MF_red = cp.GO.MF_red)
  write.xlsx(gol,name)
}
```

### day 1

```{r heart_day1_mm4_vs_dr6}
plotScatter(x="cls4.d01.mm", y="cls6.dpi1.dr", tissue="heart")
```

### day 7

```{r heart_day7_mm4_vs_dr6}
plotScatter(x="cls4.d07.mm", y="cls6.dpi7.dr", tissue="heart")
```



### mm1 vs dr4

### day 1

```{r heart_day1_mm1_vs_dr4}
plotScatter(x="cls1.d01.mm", y="cls4.dpi1.dr", tissue="heart")
```


### day 7

```{r heart_day7_mm1_vs_dr4}
plotScatter(x="cls1.d07.mm", y="cls4.dpi7.dr", tissue="heart")
```



# Session Info

```{r session, message=FALSE, warning=FALSE, cache=FALSE,echo=FALSE, fig.width=10, fig.height=5.5, context="data"}
sessionInfo()
```
