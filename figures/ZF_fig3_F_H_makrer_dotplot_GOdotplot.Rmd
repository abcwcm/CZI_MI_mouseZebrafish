---
title: "Score markers --  myeloid cells -- M0_k50_cl9.15k50"
subtitle: "zebrafish"
author: "pz"
date: "11/10/2022; updated `r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_depth: 6
        toc_float: true
        code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy = FALSE, message=FALSE, warning = FALSE)
```

```{r eval=TRUE, include=FALSE, cache=FALSE }
library(SingleCellExperiment);library(magrittr);
library(data.table)
library(patchwork);library(ggplot2)
library(clusterProfiler);library(stringr);library(org.Dr.eg.db)
theme_set(theme_bw(base_size = 16))
```



```{r}
data_dir <- "./"
sce <- readRDS(paste0(data_dir, "sce_ZF_sampleIntegration_2022-02-02_noCounts.rds"))
coldata <- readRDS("colData_ZF_withM0Only-and-EpiCardMix-Redone.rds")
reddim <- readRDS("reducedDimList_ZF_withM0Only-and-EpiCardMix-Redone.rds")

table(row.names( colData(sce)) == row.names(coldata))
table(row.names(reddim@listData$UMAP) == row.names(reducedDim(sce, "UMAP")))
colData(sce) = coldata
reducedDims(sce) = reddim
scm = sce
scm = scm[,!is.na(scm$M0_k50_cl9.15k50)]

rownames(scm) <- scater::uniquifyFeatureNames(ID = rowData(scm)$ID, names = rowData(scm)$Symbol)

cluster_cols = ABCutilities:::fx.get_palette_ABC("tableau20")[1:length(unique(scm$M0_k50_cl9.15k50))]
names(cluster_cols) <- sort(unique(scm$M0_k50_cl9.15k50))
cdata = colData(scm)
saveRDS(cdata, "zebrafish_myeloid_cdata.Rds")
homologs = readRDS("/Users/pz/Desktop/work/czi-inflammation/combined/data/rowData_ZFMMHomolog.RDS")
```


```{r fig.height = 7.5, fig.width = 15}
p1 <- scABC2::plot_reducedDim_from_sce(scm, which_reddim = "UMAP_M0_k50_cl9.15",
    color_by = "M0_k50_cl9.15k50", set_color=TRUE) +
    theme(legend.position = "right")
p2 <- scABC2::plot_reducedDim_from_sce(scm, which_reddim = "UMAP_M0_k50_cl9.15",
    color_by = "Tissue", set_color=TRUE) +
    theme(legend.position = "right")
p1+p2
```



# ScoreMarkers

In the context of marker detection, the area under the curve (AUC) quantifies our ability to distinguish between two distributions in a pairwise comparison. The AUC represents the probability that a randomly chosen observation from our cluster of interest is greater than a randomly chosen observation from the other cluster. A value of 1 corresponds to upregulation, where all values of our cluster of interest are greater than any value from the other cluster; a value of 0.5 means that there is no net difference in the location of the distributions; and a value of 0 corresponds to downregulation.

The most obvious summary statistic is the mean. For cluster  X, a large mean effect size (>0.5 for the AUCs) indicates that the gene is upregulated in X compared to the average of the other groups:

-mean.*, the mean effect size across all pairwise comparisons involving X. A large value (>0 for log-fold changes, >0.5 for the AUCs) indicates that the gene is upregulated in X compared to the average of the other groups. A small value (<0 for the log-fold changes, <0.5 for the AUCs) indicates that the gene is downregulated in X instead.

```{r}
mrks <- scran::scoreMarkers(scm, group = scm$M0_k50_cl9.15k50, block = scm$Sample)
rdata = rowData(scm)

mrks_l = lapply(as.list(mrks), function(x){
  auc.only <- x[,grepl("mean.AUC|mean.logFC.cohen", colnames(x))]
  x = data.frame(gene=row.names(auc.only), auc.only)
  x = merge(x, rdata, by="row.names")
  x
})

mrks_l_filt = lapply(as.list(mrks), function(x){
  auc.only <- x[,grepl("mean.AUC|mean.logFC.cohen", colnames(x))]
  x = data.frame(gene=row.names(auc.only), auc.only)
  x= subset(x, mean.AUC > 0.6)
  x = merge(x, rdata, by="row.names")
  x
})
#openxlsx::write.xlsx(mrks_l_filt, file = paste0(data_dir,"ZF_scoreMarkers_M0_k50_cl9.15k50_2022-11_auc_filtered_meanAUCgt0.6.xlsx"))
```


```{r}
df_sig = lapply(1:length(mrks), function(x){
  sub = mrks[[x]]
  data.frame(cluster=paste0("cls",x), 
             "mean.AUC>0.6" = nrow(subset(sub, mean.AUC > 0.6)),
             "mean.AUC>0.7" = nrow(subset(sub, mean.AUC > 0.7)), check.names=F)
}) %>% rbindlist()
df_df = reshape2::melt(df_sig)
cluster_cols_s = cluster_cols
names(cluster_cols_s) = paste0("cls", names(cluster_cols_s))
ggplot(df_df, aes(x=cluster, y=value, fill=cluster)) + geom_col() + facet_wrap(~variable, scales="free") + theme_bw() + theme(legend.position = "none") + xlab("") + ylab("Number of Marker Genes") + scale_fill_manual(values=cluster_cols_s) + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```


# Dotplot 

Using top 10 marker genes per cluster

```{r fig.height = 5, fig.width = 13}
res_auc7 <- lapply(1:length(mrks), function(x){
  sub = mrks[[x]]
  sub = subset(sub, mean.AUC > 0.6)
  sub = sub[order(sub$mean.AUC, decreasing = T),"mean.AUC", drop=F]
  sub = head(sub, 10)
  df = data.frame(gene = row.names(sub))
  df$cluster = paste0("cls", x)
  df
}) %>% rbindlist()

dittoSeq::dittoDotPlot(scm, vars =unique(res_auc7$gene), group.by = "M0_k50_cl9.15k50",scale = T) +ggtitle("") + scale_color_gradient2(low = "gray",mid = "white", high = "darkblue", name = 'relative\nexpression') 
```



# ORT testing {.tabset}

using results from mean.AUC > 0.6


clusterProfiler params:

- pvalueCutoff = 0.01
- qvalueCutoff=0.05


```{r eval=TRUE, fig.width=10, results='asis', fig.height=8,fig.path='figures_4h/', dev=c('png','pdf')}
rd <- rowData(scm) %>% as.data.frame %>% as.data.table

## universe of ENTREZ IDs
all.entrez <-  clusterProfiler::bitr(rownames(scm), 
    fromType="SYMBOL", toType="ENTREZID",
    OrgDb="org.Dr.eg.db") %>%  as.data.table


comp.list <- lapply(mrks, function(x){
  x = subset(x, mean.AUC > 0.6)
  symbs = rownames(x)
    ens <- rd[Symbol %in% symbs]$ID
    print(length(ens))
    return(all.entrez[SYMBOL %in% symbs]$ENTREZID)
})
names(comp.list) <- paste0("cls", 1:length(mrks))

```

```{r GO_BP,eval=TRUE, fig.width=11, results='asis', fig.height=8,fig.path='figures_4h/', dev=c('png','pdf')}
cat("\n\n##","GO BP", "\n\n")
cp.GO = clusterProfiler::compareCluster(comp.list, fun="enrichGO",  OrgDb = org.Dr.eg.db, ont="BP",pvalueCutoff = 0.01, qvalueCutoff=0.05, readable=TRUE)
dotplot(cp.GO, title="GO BP", label_format=100) #+ scale_y_discrete(labels=function(x) str_wrap(x, width=100))
```

```{r GO_KEGG,eval=TRUE, fig.width=8, results='asis', fig.height=8,fig.path='figures_4h/', dev=c('png','pdf')}
cat("\n\n##","KEGG", "\n\n")
cp.KEGG = clusterProfiler::compareCluster(comp.list, fun="enrichKEGG", organism = "dre", pvalueCutoff = 0.01, qvalueCutoff=0.05)
cp.KEGG<- setReadable(cp.KEGG, 'org.Dr.eg.db', 'ENTREZID')
dotplot(cp.KEGG, title="KEGG", label_format=100)
#openxlsx::write.xlsx(as.data.frame(cp.KEGG), file = paste0(data_dir,"fig4h_myeloid_KEGG.xlsx"))
```



# Session Info

```{r session, message=FALSE, warning=FALSE, cache=FALSE,echo=FALSE, fig.width=10, fig.height=5.5, context="data"}
sessionInfo()
```
